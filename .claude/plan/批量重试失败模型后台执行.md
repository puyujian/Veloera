# 批量重试失败模型后台执行 - 执行计划

## 任务目标

将批量模型测试任务看板中的"批量重试失败模型"功能改为后台异步执行，复用原任务的执行节奏参数，并提供进度条和状态显示。

## 用户需求

- **复用执行参数**：Concurrency（并发数）、IntervalMs（间隔）、RetryLimit（重试次数）
- **一键重试**：无需配置对话框，直接后台执行
- **新建子任务**：创建独立的重试任务记录，关联原任务ID
- **详细进度**：显示已重试/总数、当前模型、成功/失败统计
- **更新原任务**：重试完成后更新原任务的成功/失败统计

## 技术方案

**方案 1：重试任务关联原任务**（已选择）

核心思路：
- 创建新的 `ChannelTestJob` 记录，`OptionsJSON` 中添加 `parent_job_id` 标记为重试任务
- 复用现有的 `channeltest.SubmitJob()` 和 `executeJob()` 逻辑
- 重试任务只测试原任务中失败的模型
- 任务完成后自动更新原任务统计

## 实施步骤

### 步骤 1：扩展数据模型（后端 - Model 层）

**文件**：`model/channel_test_job.go`

**操作**：
- 在 `ChannelTestJobOptions` 结构体中添加字段：
  - `ParentJobID int64` - 父任务ID（重试任务时使用）
  - `IsRetryJob bool` - 是否为重试任务

**预期结果**：数据模型支持存储重试任务的关联信息

---

### 步骤 2：实现后台重试 API（后端 - Controller 层）

**文件**：`controller/channel-test-batch.go`

**操作**：
- 新增 `RetryJobInBackground` 函数
- 实现逻辑：
  1. 解析路径参数 jobID
  2. 获取原任务记录及配置
  3. 检查任务状态（不能是 RUNNING 或 PENDING）
  4. 查询失败模型列表
  5. 创建新的重试任务（复制执行参数）
  6. 提交后台任务
  7. 返回新任务ID

**文件**：`router/api-router.go`

**操作**：
- 添加路由：`POST /api/channel/test/batch/:id/retry`

**预期结果**：API 端点可用，创建后台重试任务成功

---

### 步骤 3：增强任务执行器（后端 - Service 层）

**文件**：`channeltest/runner.go`

**操作**：
- 在 `executeJob` 函数的任务完成回调中添加逻辑
- 如果是重试任务，调用 `RefreshChannelTestJobStats(parentJobID)` 更新父任务统计

**预期结果**：重试任务完成后，自动刷新原任务的成功/失败统计

---

### 步骤 4：前端任务列表增强

**文件**：前端任务看板组件

**操作**：
1. 修改任务列表显示逻辑：
   - 解析 `job.options.is_retry_job` 判断是否为重试任务
   - 显示"重试任务"标识
   - 显示原任务关联关系

2. 添加批量重试按钮：
   - 在任务详情操作栏添加"批量重试失败模型"按钮
   - 实现 `handleRetryJob` 函数
   - 调用后台 API 创建重试任务

**预期结果**：
- 用户可一键触发后台重试
- 任务列表清晰显示重试任务

---

### 步骤 5：前端进度展示

**操作**：
- 复用现有任务详情页的进度轮询逻辑
- 验证进度显示正常

**预期结果**：重试任务的进度实时展示

---

### 步骤 6：测试与验证

**测试点**：
1. 后端单元测试
2. 端到端测试流程
3. 边界情况测试

---

## 技术栈

- 后端：Go + Gin + GORM
- 前端：React + Semi UI + Axios
- 无需引入新库

## 风险评估

1. 数据库迁移：JSON 字段扩展，向后兼容
2. 并发控制：已通过状态检查规避
3. 前端组件定位：需先探索代码结构

## 预计工作量

总计约 2 小时

---

*生成时间：2025-10-20*
*执行模式：分阶段开发，关键步骤后请求用户反馈*
